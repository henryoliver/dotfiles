return {
    "olimorris/codecompanion.nvim",
    event = "VeryLazy",
    dependencies = {
        "nvim-lua/plenary.nvim",
        "yamatsum/nvim-nonicons",
        "nvim-treesitter/nvim-treesitter",
        "franco-ruggeri/codecompanion-spinner.nvim",
    },
    opts = {
        opts = {
            system_prompt = "",
        },
        strategies = {
            chat = {
                adapter = "anthropic",
                opts = {
                    completion_provider = "cmp",
                },
            },
            inline = { adapter = "anthropic" },
            cmd = { adapter = "anthropic" },
        },
        keymaps = {
            send = {
                callback = function(chat)
                    vim.cmd("stopinsert")
                    chat:submit()
                    chat:add_buf_message({ role = "llm", content = "" })
                end,
                index = 1,
                description = "Send",
            },
        },
        sources = {
            per_filetype = {
                codecompanion = { "codecompanion" },
            },
        },
        adapters = {
            http = {
                opts = {
                    show_defaults = false,
                },
                anthropic = function()
                    return require("codecompanion.adapters").extend("anthropic", {
                        schema = {
                            model = {
                                default = "claude-sonnet-4-5",
                            },
                        },
                    })
                end,
                openai = function()
                    return require("codecompanion.adapters").extend("openai", {
                        schema = {
                            model = {
                                default = "o1",
                            },
                        },
                    })
                end,
                xai = function()
                    return require("codecompanion.adapters").extend("xai", {
                        schema = {
                            model = {
                                default = "grok-2-latest",
                            },
                        },
                    })
                end,
            },
            acp = {
                claude_code = function()
                    return require("codecompanion.adapters").extend("claude_code", {})
                end,
            },
        },
        display = {
            chat = {
                intro_message = "",
                show_token_count = true,
                icons = {
                    pinned_buffer = "" .. require("nvim-nonicons").get("milestone") .. " ",
                    watched_buffer = "" .. require("nvim-nonicons").get("eye") .. " ",
                },
                window = {
                    opts = {
                        number = false,
                        relativenumber = false,
                        colorcolumn = "",
                        foldenable = false,
                        foldmethod = "manual",
                        foldlevel = 99,
                    },
                },
            },
            diff = { enabled = false },
        },
        extensions = {
            spinner = {},
        },
    },
